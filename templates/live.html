{% extends "layout.html" %}
{% block content %}

<h2>Live Feed (last 25 messages)</h2>

<div id="filters" style="margin-bottom:10px;">
    <button onclick="setFilter('all')">All</button>
    <button onclick="setFilter('pdp')">Police</button>
    <button onclick="setFilter('fdp')">Fire</button>
    <button onclick="setFilter('ems')">Ambulance</button>
    <button onclick="setFilter('lfl')">MMT/Traumaheli</button>
</div>

<div id="messages">Loadingâ€¦</div>

<style>
/* Highlight new messages briefly */
.msg.new {
    background-color: #ffff99;
    animation: fadeHighlight 2s ease-out;
}

/* Fade animation */
@keyframes fadeHighlight {
    from { background-color: #ffff99; }
    to { background-color: white; }
}

/* Color coding (matches Python coloriz()) */
.msg.lfl { border-left: 5px solid #32CD32; }   /* green, MMT / Traumaheli */
.msg.fdp { border-left: 5px solid #FF4500; }   /* red, Fire / Brandweer */
.msg.ems { border-left: 5px solid #FFD700; }   /* yellow, Ambulance */
.msg.pdp { border-left: 5px solid #1E90FF; }   /* blue, Police */

.msg {
    padding: 10px;
    margin-bottom: 5px;
    border-bottom: 1px solid #ddd;
}
button {
    margin-right:5px;
    padding:5px 10px;
    cursor:pointer;
}
button.active {
    background-color:#0077cc;
    color:white;
    border:none;
}
</style>

<script>
let currentIds = new Set();
let currentFilter = 'all';

function setFilter(service) {
    currentFilter = service;
    document.querySelectorAll('#filters button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    renderMessages(lastData);  // re-render with new filter
}

// Store last fetched data to re-render when filter changes
let lastData = [];

function getServiceClass(msg) {
    const cap = msg.capcodes || "";
    const text = msg.message || "";

    const c = cap.toUpperCase();
    const t = text.toUpperCase();

    if (/000120901|000923993|001420059|MMT|TRAUMAHELI/.test(c) ||
        /MMT|TRAUMAHELI/.test(t)) return "lfl";

    if (/00\d\d0\d{4}/.test(c) || /^[Pp]\s?[12]/.test(t) || /PRIO/.test(t)) return "fdp";

    if (/00\d\d2\d{4}/.test(c) || /^[AB][12]/.test(t)) return "ems";

    if (/00\d\d3\d{4}/.test(c) || /POLITIE/.test(t)) return "pdp";

    return "";
}

function renderMessages(data) {
    let container = document.getElementById("messages");
    let html = "";
    let newIds = new Set();

    data.forEach(m => {
        newIds.add(m.id);
        let isNew = !currentIds.has(m.id);
        let serviceClass = getServiceClass(m);

        // Apply filter
        if (currentFilter !== 'all' && serviceClass !== currentFilter) return;

        html += `
        <div class="msg ${serviceClass}${isNew ? ' new' : ''}" data-id="${m.id}">
            <div class="capcodes">${m.capcodes}</div>
            <div>${m.message}</div>
            <div class="timestamp">${m.timestamp}</div>
        </div>`;
    });

    container.innerHTML = html;
    currentIds = newIds;
}

// Fetch and update messages
async function loadLatest() {
    const r = await fetch("/api/latest");
    const data = await r.json();
    lastData = data;   // store for re-render on filter change
    renderMessages(data);
}

// Load immediately and refresh every second
loadLatest();
setInterval(loadLatest, 1000);
</script>

{% endblock %}
