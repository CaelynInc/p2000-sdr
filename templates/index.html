{% extends "layout.html" %}
{% block content %}

<h2>Live Messages</h2>
<p>Total messages: {{ total }} | Render time: {{ elapsed|round(1) }} ms</p>

<!-- Filter buttons -->
<div id="filters" style="margin-bottom:10px;">
    <button onclick="setFilter('all')" class="active">All</button>
    <button onclick="setFilter('pdp')">Police</button>
    <button onclick="setFilter('fdp')">Fire</button>
    <button onclick="setFilter('ems')">Ambulance</button>
    <button onclick="setFilter('lfl')">MMT/Traumaheli</button>
</div>

<div id="messages">Loading messages...</div>

<style>
/* Service color bars on cards */
.msg-card.lfl { border-left: 5px solid #32CD32; }
.msg-card.fdp { border-left: 5px solid #FF4500; }
.msg-card.ems { border-left: 5px solid #FFD700; }
.msg-card.pdp { border-left: 5px solid #1E90FF; }
</style>

<script>
let currentIds = new Set();
let lastData = [];
let currentFilter = 'all';

// Determine service class
function getServiceClass(msg) {
    const cap = msg.capcodes || "";
    const text = msg.message || "";
    const c = cap.toUpperCase();
    const t = text.toUpperCase();
    if (/000120901|000923993|001420059|MMT|TRAUMAHELI/.test(c) || /MMT|TRAUMAHELI/.test(t)) return "lfl";
    if (/00\d\d0\d{4}/.test(c) || /PRIO/.test(t)) return "fdp";
    if (/00\d\d2\d{4}/.test(c) || /^A[12]|^B[12]/.test(t)) return "ems";
    if (/00\d\d3\d{4}/.test(c) || /POLITIE/.test(t)) return "pdp";
    return "";
}

// Render messages with filter and clickable links
function renderMessages(data) {
    const container = document.getElementById("messages");
    let html = "";
    let newIds = new Set();

    data.forEach(m => {
        newIds.add(m.id);
        const isNew = !currentIds.has(m.id);
        const cls = getServiceClass(m);
        if (currentFilter !== 'all' && cls !== currentFilter) return;
        html += `
        <div class="msg-card ${cls}${isNew ? ' new' : ''}" data-id="${m.id}" onclick="openMessage(${m.id})">
            <strong>${m.message}</strong><br>
            <span class="timestamp">${m.timestamp}</span><br>
            Capcodes: ${m.capcodes}
        </div>`;
    });

    container.innerHTML = html;
    currentIds = newIds;
}

// Open detailed message page
function openMessage(id) {
    window.location.href = "/message/" + id;
}

// Filter button handler
function setFilter(service) {
    currentFilter = service;
    document.querySelectorAll('#filters button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderMessages(lastData);
}

// Fetch latest messages
async function loadLatest() {
    const r = await fetch("/api/latest");
    const data = await r.json();
    lastData = data;
    renderMessages(data);
}

// Initial load + refresh every second
loadLatest();
setInterval(loadLatest, 1000);
</script>

{% endblock %}
