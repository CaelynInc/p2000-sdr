{% extends "layout.html" %}
{% block content %}

<h2>Live Messages</h2>
<p>Total messages: {{ total }} | Render time: {{ elapsed|round(1) }} ms</p>

<!-- Filter buttons -->
<div id="filters" style="margin-bottom:10px;">
    <button onclick="setFilter('all')" class="active">All</button>
    <button onclick="setFilter('pdp')">Police</button>
    <button onclick="setFilter('fdp')">Fire</button>
    <button onclick="setFilter('ems')">Ambulance</button>
    <button onclick="setFilter('lfl')">MMT/Traumaheli</button>
</div>

<div id="messages">Loading messages...</div>

<style>
/* Service color bars */
.msg-card.lfl { border-left: 5px solid #32CD32; }
.msg-card.fdp { border-left: 5px solid #FF4500; }
.msg-card.ems { border-left: 5px solid #FFD700; }
.msg-card.pdp { border-left: 5px solid #1E90FF; }

/* Base card style */
.msg-card {
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    padding: 8px 12px;
    margin-bottom: 8px;
    cursor: pointer;
    font-size: 14px;
    line-height: 1.3;
    transition: background-color 0.4s ease;
}

/* Severity shading */
.sev-high { background-color: #ffe5e5; }      /* A1 / PRIO 1 / P1 / P 1 */
.sev-med  { background-color: #fff0d9; }      /* A2 / PRIO 2 / P2 */
.sev-low  { background-color: #ffffe0; }      /* B / Low prio */
.sev-none { background-color: #ffffff; }

/* Highlight new messages */
.msg-card.new {
    animation: fadeHighlight 1.4s ease-out;
}

@keyframes fadeHighlight {
    from { background-color: #ffff99; }
    to { background-color: inherit; }
}

.msg-text { margin-bottom: 3px; }
.timestamp { font-size: 11px; color: #777; }
</style>

<script>
let currentIds = new Set();
let lastData = [];
let currentFilter = 'all';

// Determine service class
function getServiceClass(msg) {
    const cap = msg.capcodes || "";
    const text = msg.message || "";
    const c = cap.toUpperCase();
    const t = text.toUpperCase();
    if (/000120901|000923993|001420059|MMT|TRAUMAHELI/.test(c) || /MMT|TRAUMAHELI/.test(t)) return "lfl";
    if (/00\d\d0\d{4}/.test(c) || /PRIO/.test(t)) return "fdp";
    if (/00\d\d2\d{4}/.test(c) || /^A[12]|^B[12]/.test(t)) return "ems";
    if (/00\d\d3\d{4}/.test(c) || /POLITIE/.test(t)) return "pdp";
    return "";
}

// Severity classifier â€” updated to match "P 1" and variants
function getSeverityClass(msg) {
    const t = (msg.message || "").toUpperCase();

    // Match PRIO 1, PRIO1, P1, P 1, A1, etc.
    if (/\b(A1|PRIO\s*1|P\s*1|P1)\b/.test(t)) return "sev-high";

    // Match PRIO 2, PRIO2, P2, P 2, A2
    if (/\b(A2|PRIO\s*2|P\s*2|P2)\b/.test(t)) return "sev-med";

    // Match B1/B2 or PRIO 3 / P3
    if (/\b(B1|B2|PRIO\s*3|P\s*3|P3)\b/.test(t)) return "sev-low";

    return "sev-none";
}

// Render message cards
function renderMessages(data) {
    const container = document.getElementById("messages");
    let html = "";
    let newIds = new Set();

    data.forEach(m => {
        newIds.add(m.id);
        const isNew = !currentIds.has(m.id);

        const serviceClass = getServiceClass(m);
        const severityClass = getSeverityClass(m);

        if (currentFilter !== 'all' && serviceClass !== currentFilter)
            return;

        html += `
        <div class="msg-card ${serviceClass} ${severityClass}${isNew ? ' new' : ''}"
             onclick="openMessage(${m.id})">
            <div class="msg-text">${m.message}</div>
            <div class="timestamp">${m.timestamp}</div>
        </div>`;
    });

    container.innerHTML = html;
    currentIds = newIds;
}

function openMessage(id) {
    window.location.href = "/message/" + id;
}

function setFilter(service) {
    currentFilter = service;
    document.querySelectorAll('#filters button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderMessages(lastData);
}

async function loadLatest() {
    const r = await fetch("/api/latest");
    const data = await r.json();
    lastData = data;
    renderMessages(data);
}

loadLatest();
setInterval(loadLatest, 1000);
</script>

{% endblock %}
