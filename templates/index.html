{% extends "layout.html" %}
{% block content %}

<p style="text-align:center;">Total messages: {{ total }} | Render time: {{ elapsed|round(1) }} ms</p>

<!-- Severity Legend -->
<div id="legend" style="display:flex; justify-content:center; gap:12px; margin-bottom:10px; font-size:13px;">
    <div class="legend-item"><span class="legend-color" style="background-color:#8B0000"></span> High Priority (A1 / P1)</div>
    <div class="legend-item"><span class="legend-color" style="background-color:#FF8C00"></span> Medium Priority (A2 / P2)</div>
    <div class="legend-item"><span class="legend-color" style="background-color:#FFD700"></span> Low Priority (B / PRIO3)</div>
</div>

<!-- Filter buttons -->
<div id="filters" style="display:flex; justify-content:center; gap:6px; margin-bottom:10px;">
    <button onclick="setFilter('all')" class="active">All</button>
    <button onclick="setFilter('pdp')">Police</button>
    <button onclick="setFilter('fdp')">Fire</button>
    <button onclick="setFilter('ems')">Ambulance</button>
    <button onclick="setFilter('lfl')">MMT/Traumaheli</button>
</div>

<div id="messages" style="display:flex; flex-direction:column; align-items:center;">Loading messages...</div>

<style>
/* Service color bars */
.msg-card.lfl { border-left: 5px solid #32CD32; }
.msg-card.fdp { border-left: 5px solid #FF4500; }
.msg-card.ems { border-left: 5px solid #FFD700; }
.msg-card.pdp { border-left: 5px solid #1E90FF; }

/* Message cards */
.msg-card {
    max-width: 700px;
    width: 100%;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    transition: background-color 0.25s, color 0.25s;
    padding: 8px 12px;
    margin-bottom: 8px;
    cursor: pointer;
    font-size: 14px;
    line-height: 1.3;
}

/* Severity classes */
.sev-high { background-color: var(--sev-high-bg); }
.sev-med  { background-color: var(--sev-med-bg); }
.sev-low  { background-color: var(--sev-low-bg); }
.sev-none { background-color: var(--card-bg); }

/* New messages highlight */
.msg-card.new {
    animation: fadeHighlight 1.2s ease-out;
}

@keyframes fadeHighlight {
    from { background-color: var(--new-bg); }
    to { background-color: inherit; }
}

.msg-text { margin-bottom: 3px; }
.timestamp { font-size: 11px; color: var(--timestamp); }
</style>

<script>
let currentIds = new Set();
let lastData = [];
let currentFilter = 'all';

function getServiceClass(msg) {
    const c = (msg.capcodes || "").toUpperCase();
    const t = (msg.message || "").toUpperCase();
    if (/000120901|000923993|001420059|MMT|TRAUMAHELI/.test(c) || /MMT|TRAUMAHELI/.test(t)) return "lfl";
    if (/00\d\d0\d{4}/.test(c) || /PRIO/.test(t)) return "fdp";
    if (/00\d\d2\d{4}/.test(c) || /^A[12]|^B[12]/.test(t)) return "ems";
    if (/00\d\d3\d{4}/.test(c) || /POLITIE/.test(t)) return "pdp";
    return "";
}

function getSeverityClass(msg) {
    const t = (msg.message || "").toUpperCase();
    if (/\b(A1|PRIO\s*1|P\s*1|P1)\b/.test(t)) return "sev-high";
    if (/\b(A2|PRIO\s*2|P\s*2|P2)\b/.test(t)) return "sev-med";
    if (/\b(B1|B2|PRIO\s*3|P\s*3|P3)\b/.test(t)) return "sev-low";
    return "sev-none";
}

function renderMessages(data) {
    const container = document.getElementById("messages");
    let newIds = new Set();
    let html = "";

    data.forEach(m => {
        const isNew = !currentIds.has(m.id);
        newIds.add(m.id);

        const service = getServiceClass(m);
        const sev = getSeverityClass(m);

        if (currentFilter !== "all" && service !== currentFilter) return;

        html += `
        <div class="msg-card ${service} ${sev}${isNew ? ' new' : ''}"
             onclick="openMessage(${m.id})">
            <div class="msg-text">${m.message}</div>
            <div class="timestamp">${m.timestamp}</div>
        </div>`;
    });

    currentIds = newIds;
    container.innerHTML = html;
}

function openMessage(id) {
    window.location.href = "/message/" + id;
}

function setFilter(service) {
    currentFilter = service;
    document.querySelectorAll("#filters button").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    renderMessages(lastData);
}

async function loadLatest() {
    const r = await fetch("/api/latest");
    lastData = await r.json();
    renderMessages(lastData);
}

loadLatest();
setInterval(loadLatest, 1000);
</script>

{% endblock %}

