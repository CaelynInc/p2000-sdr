{% extends "layout.html" %}
{% block content %}

<p style="text-align:center;">Total messages: {{ total }} | Render time: {{ elapsed|round(1) }} ms</p>

<!-- Filter buttons -->
<div id="filters" style="display:flex; justify-content:center; gap:6px; margin-bottom:10px;">
    <button onclick="setFilter('all')" class="active">All</button>
    <button onclick="setFilter('pdp')">Police</button>
    <button onclick="setFilter('fdp')">Fire</button>
    <button onclick="setFilter('ems')">Ambulance</button>
    <button onclick="setFilter('lfl')">MMT/Traumaheli</button>
</div>

<div id="messages" style="display:flex; flex-direction:column; align-items:center;">Loading messages...</div>

<style>
/* Service color bars */
.msg-card.lfl { border-left: 5px solid #32CD32; }
.msg-card.fdp { border-left: 5px solid #FF4500; }
.msg-card.ems { border-left: 5px solid #FFD700; }
.msg-card.pdp { border-left: 5px solid #1E90FF; }

/* Softer service borders in dark mode */
:root.dark .msg-card.lfl { border-left-color: #228b22; }
:root.dark .msg-card.fdp { border-left-color: #cc3300; }
:root.dark .msg-card.ems { border-left-color: #cca300; }
:root.dark .msg-card.pdp { border-left-color: #1c75ff; }

/* Message cards */
.msg-card {
    max-width: 700px;
    width: 100%;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    transition: background-color 0.25s, color 0.25s, border-color 0.25s;
    padding: 8px 12px;
    margin-bottom: 8px;
    cursor: pointer;
    font-size: 14px;
    line-height: 1.3;
}

/* Severity highlight classes */
.sev-high { background-color: #ffcccc; }
.sev-med { background-color: #fff0b3; }
.sev-low { background-color: #e0ffe0; }

/* Dark mode severity */
:root.dark .sev-high { background-color: #992222; }
:root.dark .sev-med { background-color: #997722; }
:root.dark .sev-low { background-color: #227722; }

/* New messages highlight */
.msg-card.new {
    animation: fadeHighlight 1.2s ease-out;
}
@keyframes fadeHighlight {
    from { background-color: var(--new-bg, #ddf); }
    to { background-color: inherit; }
}

.msg-text { margin-bottom: 3px; }
.timestamp { font-size: 11px; color: var(--timestamp, #666); }
</style>

<script>
let currentIds = new Set();
let lastData = [];
let currentFilter = 'all';

function getServiceClass(msg) {
    const c = (msg.capcodes || "").toUpperCase();
    const t = (msg.message || "").toUpperCase();
    if (/000120901|000923993|001420059|MMT|TRAUMAHELI/.test(c) || /MMT|TRAUMAHELI/.test(t)) return "lfl";
    if (/00\d\d0\d{4}/.test(c) || /PRIO/.test(t)) return "fdp";
    if (/00\d\d2\d{4}/.test(c) || /^A[12]|^B[12]/.test(t)) return "ems";
    if (/00\d\d3\d{4}/.test(c) || /POLITIE/.test(t)) return "pdp";
    return "";
}

function getSeverityClass(msg) {
    const t = (msg.message || "").toUpperCase();
    if (/\b(A1|PRIO\s*1|P\s*1|P1)\b/.test(t)) return "sev-high";
    if (/\b(A2|PRIO\s*2|P\s*2|P2)\b/.test(t)) return "sev-med";
    if (/\b(B1|B2|PRIO\s*3|P\s*3|P3)\b/.test(t)) return "sev-low";
    return "";
}

function renderMessages(data) {
    const container = document.getElementById("messages");
    let html = "";
    let newIds = new Set();

    data.forEach(m => {
        newIds.add(m.id);
        const isNew = !currentIds.has(m.id);
        const cls = getServiceClass(m);
        const sev = getSeverityClass(m);
        if (currentFilter !== 'all' && cls !== currentFilter) return;

        html += `
        <div class="msg-card ${cls} ${sev}${isNew ? ' new' : ''}" onclick="openMessage(${m.id})">
            <div class="msg-text">${m.message}</div>
            <div class="timestamp">${m.timestamp}</div>
        </div>`;
    });

    currentIds = newIds;
    container.innerHTML = html;
}

function openMessage(id) { window.location.href = "/message/" + id; }
function setFilter(service) {
    currentFilter = service;
    document.querySelectorAll("#filters button").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    renderMessages(lastData);
}

async function loadLatest() {
    const r = await fetch("/api/latest");
    lastData = await r.json();
    renderMessages(lastData);
}

loadLatest();
setInterval(loadLatest, 1000);
</script>

{% endblock %}
